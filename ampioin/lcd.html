<script type="text/javascript">
    RED.nodes.registerType('Ampio LCD',{
        category: 'Ampio',
        color: '#d4d9db',
        defaults: {
            lcdfont: {value:"07"},
            lcdxpos: {value:"0"},
            lcdypos: {value:"0"},
            lcdcharcolor: {value:"000000"},
            lcdbackcolor: {value:"FFFFFF"},
            mac: {value:""},
            name: {value:""},
            srvaddress: {value:"localhost"}
        },
        inputs:1,
        outputs:0,
        icon: "face.png",
        align: "right",
        label: function() {
            return this.name||"Ampio LCD";
        },
        oneditprepare: function(){
            var node = this;
            var devices;
            var DevTypes;
            var ip = $('#node-input-srvaddress').val();
            $.getJSON('ampio/devices/types',function(json){
                DevTypes = json;
            });
            function pad (str, max) {
                str = str.toString();
                return str.length < max ? pad("0" + str, max) : str;
            }
            function GetDevices(ip){
                $("#node-input-mac").empty();
                $.getJSON('ampio/devices/list/'+ip, function(data) {
                    for (var i = 0; i< data.length; i++){
                        var dev = data[i];
                        if(dev.typ == 27 || dev.typ == 32 || dev.typ == 51 || dev.typ == 52){
                            $("<option value='" + dev.user_mac + "'> " + pad(dev.user_mac,4) + " - " + (DevTypes[dev.typ].type) + " (" + atob(dev.name) + ")</option>").appendTo('#node-input-mac');
                        }
                    }
                    if(node.mac != ""){
                        $("#node-input-mac").val(node.mac);
                        $('#node-input-mac').trigger('change');
                    }
                });
            }
            GetDevices(ip);
            
            $("#node-input-lookup-devices").on("click",function(){
                var ip = $('#node-input-srvaddress').val();
                $("node-input-mac").html("");
                GetDevices(ip);
            });
        }
        
    });
</script>

<script type="text/x-red" data-template-name="Ampio LCD">
    <div class="form-row">
        <label for="node-input-srvaddress"><i class="icon-tag"></i> Server address</label>
        <input type="text" id="node-input-srvaddress">    
        </input>
    </div>
    <div class="form-row">
        <label for="node-input-mac"><i class="icon-tag"></i> Target device</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <select id="node-input-mac" style="width: 100%;"></select>
            </div>
            <a id="node-input-lookup-devices" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-lcdfont"><i class="icon-tag"></i> LCD font size</label>
        <select type="text" id="node-input-lcdfont" style="width: 70%;">
            <option value="07" selected>Standard (10x16)</option>
            <option value="09">Big (20x32)</option>
            <option value="0A">Icon (40x40)</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-lcdxpos"><i class="icon-tag"></i> LCD X position</label>
        <input type="text" id="node-input-lcdxpos" placeholder="ex. 12">
    </div>
    <div class="form-row">
        <label for="node-input-lcdypos"><i class="icon-tag"></i> LCD Y position</label>
        <input type="text" id="node-input-lcdypos" placeholder="ex. 14">
    </div>
    <div class="form-row">
        <label for="node-input-lcdcharcolor"><i class="icon-tag"></i> LCD text color (hex)</label>
        <input type="text" id="node-input-lcdcharcolor" placeholder="ex. #ff12bb">
    </div>
    <div class="form-row">
        <label for="node-input-lcdbackcolor"><i class="icon-tag"></i> LCD bg color (hex)</label>
        <input type="text" id="node-input-lcdbackcolor" placeholder="ex. #ff12bb">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
â€¨
<script type="text/x-red" data-help-name="Ampio LCD">
    <p>Ampio node used to send strings and commands to Ampio MDOT-LCD modules.<br/>
        <h3>LCD Font</h3>
        Defines the font we want to use. Standard font can show up to 11 chars in 1 line, Big font can handle up to 6 chars. Icon command will show previously uploaded (through Ampio CAN programmer) icon with defined ID.
        <h3>LCD X, Y position</h3>
        Here you have to provide informations, where device have to start writing text. Position is counted from top left corner of screen, only positive values are valid. 
        <h3>MAC (required)</h3>
        Here you have to write MAC address of Ampio CAN device.
    </p>
</script>
