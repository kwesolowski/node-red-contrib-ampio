<script type="text/javascript">
    RED.nodes.registerType('Ampio OUT',{
        category: 'Ampio',
        color: '#d4d9db',
        defaults: {
            valtype: {value:"s"},
            mac: {value:""},
            ioid: {value:""},
            name: {value:""},
            srvaddress: {value:"localhost"}
        },
        inputs:1,
        outputs:0,
        icon: "face.png",
        align: "right",
        label: function() {
            return this.name||"Ampio OUT";
        },
        oneditprepare: function(){
            var node = this;
            var DevTypes;
            $.getJSON('ampio/devices/types',function(json){
                DevTypes = json;
            });
            function pad (str, max) {
                str = str.toString();
                return str.length < max ? pad("0" + str, max) : str;
            }
            function GetDevices(){
                var ip = $('#node-input-srvaddress').val();
                $("#node-input-mac").empty();
                $.getJSON('ampio/devices/list/'+ip, function(data) {
                        for (var i = 0; i< data.length; i++){
                            var dev = data[i];
                            $("<option value='" + dev.user_mac + "'> " + pad(dev.user_mac,4) + " - " + (DevTypes[dev.typ].type) + " (" + atob(dev.name) + ")</option>").appendTo('#node-input-mac');
                        }
                        if(node.mac != ""){
                            $("#node-input-mac").val(node.mac);
                            $('#node-input-mac').trigger('change');
                        }
                    
                });
            }


            GetDevices();
            $("#node-input-lookup-devices").on("click",function(){
                GetDevices();
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="Ampio OUT">
    <div class="form-row">
        <label for="node-input-valtype"><i class="icon-tag"></i> Cmd type</label>
        <select type="text" id="node-input-valtype" style="width: 70%;">
            <option value="s" selected>Standard</option>
            <option value="r">Raw CAN broadcast</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-srvaddress"><i class="icon-tag"></i> Server address</label>
        <input type="text" id="node-input-srvaddress" placeholder="localhost">
    </div>
    <div class="form-row">
        <label for="node-input-mac"><i class="icon-tag"></i> Target device</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <select id="node-input-mac" style="width: 100%;"></select>
            </div>
            <a id="node-input-lookup-devices" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row" style="display: none;" id="ioid">
        <label for="node-input-ioid"><i class="icon-tag"></i> I/O ID</label>
        <input type="text" id="node-input-ioid" placeholder="ex. 1">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    

    <script type="text/javascript">
        $("#node-input-valtype").change(function(){
            var e = document.getElementById("node-input-valtype");
            if(e.options[e.selectedIndex].value=="s"){
                document.getElementById("ioid").style.display = "block";
            }
            else{
                document.getElementById("ioid").style.display = "none";
            }
        })
    </script>
</script>
â€¨
<script type="text/x-red" data-help-name="Ampio OUT">
    <p>Ampio node to send Ampio Smart Home messages to device with specified mac address and specified out-/in-/put.<br/>
        <h3>Cmd type (required)</h3>
        Used to define type of command<br>
        -   RAW commands are explained in Ampio MQTT documentation. Recommended only for advanced users. In this help only standard commands will be explained.<br>
        -   Standard commands are recommended for all users and for most applications. Payload for standard command is delivered by single string value, which can be number to define analog value, ON or OFF to define binary state (also in analog devices - OFF means 0, and ON means maximum value) or color in R,G,B (ex. "123,233,98").<br>
        <h3>MAC (required)</h3>
        Here you have to write MAC address of Ampio CAN device.
        <h3>I/O ID (required for Standard command)</h3>
        You have to fill it in only if you selected "Standard" Cmd type. It defines number of output on Ampio module.  
    </p>
</script>
